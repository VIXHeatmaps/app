<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Heatmap Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; font-size: 12px; margin: 16px; }
    .controls { flex: 1; }
    .right-controls { min-width: 270px; gap: 7px; font-size: 12px; }
    .heatmap-section { margin-top: 16px; padding-bottom: 12px; border-bottom: 1px solid #eee; font-size: 12px; }
    .colorbar-float {
      position: absolute; right: 13px; z-index: 2; width: 48px; display: flex; flex-direction: column; align-items: center;
      pointer-events: none; /* allow clicking through except on inputs */
    }
    .colorbar-float input { font-size: 12px; width: 42px; margin: 0 0 1px 0; text-align: center; pointer-events: auto; }
    .colorbar-label-float { font-size: 12px; font-weight: bold; background: #fff; padding: 0 3px; margin-bottom: 2px;}
    .colorbar-label-float-bottom { margin-top: 1px; margin-bottom: 0;}
    .plot-container { position: relative; }
    /* Symbol multi-select: longer, up to 500px */
    .symbol-multiselect { width: 320px; max-width: 500px; font-size: 12px;}
    .symbol-multiselect-list { max-height: 340px; font-size: 12px;}
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div class="controls">
      <div style="font-size: 16px; font-style: italic; margin-bottom: 10px;"><b>Metric:</b> H = (AR – AR<sub>min</sub>) / max(MD, MD<sub>min</sub>) <span style="font-size: 12px;">(decimal)</span></div>
      <div style="font-weight:bold; margin-bottom:4px;">Symbol:
        <div class="symbol-multiselect" id="symbolMultiSelectBox">
          <div class="selected-label" tabindex="0" id="symbolMultiSelectLabel">Select Symbol</div>
          <div class="symbol-multiselect-list" id="symbolMultiSelectList" style="display:none;"></div>
        </div>
        <button id="clearDataBtn" style="margin-left:8px; font-size:12px;">Clear Data</button>
      </div>
      <div><b>AR Min. (%):</b>
        <input type="range" id="arFloor" min="0" max="100" step="0.1" value="3" style="width:140px;">
        <input type="number" id="arFloorNum" min="0" max="100" step="0.1" value="3" style="width:34px;">
      </div>
      <div><b>MD Min. (%):</b>
        <input type="range" id="mdMin" min="0" max="100" step="0.1" value="5" style="width:140px;">
        <input type="number" id="mdMinNum" min="0" max="100" step="0.1" value="5" style="width:34px;">
      </div>
      <div><b>MD Max (%):</b>
        <input type="range" id="mdCeil" min="0" max="100" step="0.1" value="50" style="width:140px;">
        <input type="number" id="mdCeilNum" min="0" max="100" step="0.1" value="50" style="width:34px;">
      </div>
      <div style="margin:4px 0;"><b id="currentMaxH" style="font-size:12px;">Current Max H: --</b></div>
    </div>
    <div class="right-controls">
      <div style="font-size: 12px;"><label for="dataSourceSelect">Data Source:</label>
        <select id="dataSourceSelect">
          <option>Exxahub</option>
          <option>Testfol.io</option>
          <option>Composer</option>
          <option>Quantmage</option>
          <option>Other</option>
        </select>
      </div>
      <div style="font-size:12px;">
        <label><b>Upload <span class="csv-link" id="showCsvTemplate">CSV</span>:</b></label>
        <input type="file" id="csvInput" accept=".csv">
      </div>
      <div style="font-size:12px;">
        <input type="checkbox" id="decimalToPercentBox">
        <label for="decimalToPercentBox" style="font-weight:normal;">Decimal → %</label>
        <span style="color: #189c2f;">(select prior to upload)</span>
      </div>
      <button id="exportCSVBtn" class="export-btn" style="font-size:12px;padding:3px 16px;">Download Data</button>
    </div>
  </div>
  <!-- CSV Modal and heatmapsContainer as before -->
  <div id="csvModal" style="display:none;">
    <div class="modal-content">
      <button id="closeModalBtn" title="Close">&times;</button>
      <div style="font-weight: bold; margin-bottom: 8px;">CSV Upload Template</div>
      <table>
        <tr><th>Symbol</th><th>Days</th><th>RSI</th><th>AR</th><th>MD</th></tr>
        <tr><td>TQQQ</td><td>9</td><td>82</td><td>13.59%</td><td>9.63%</td></tr>
      </table>
      <div style="color: #008000; font-size: 12px;">✓ Use these exact headers (<b>column order doesn't matter</b>)</div>
      <div style="margin-top:8px; color:#444; font-size: 12px;">
        You may also use: <b>Ticker</b>, <b>Name</b> for Symbol; <b>Lookback</b>, <b>Window</b> for Days; <b>Drawdown</b> for MD, <b>CAGR</b> for AR, etc.
      </div>
    </div>
  </div>
  <div id="heatmapsContainer"></div>
  <script>
    // --- All your previous JS logic as-is for multi-select, CSV, controls ---
    // [Everything before drawHeatmaps remains unchanged]

    // --- drawHeatmaps() is new/overwritten below ---
    function drawHeatmaps() {
      heatmapsContainer.innerHTML = '';
      if (!selectedSymbols.length) {
        currentMaxH.textContent = 'Current Max H: --';
        const msg = document.createElement('div');
        msg.style.textAlign = 'center'; msg.style.margin = '30px 0'; msg.style.color = '#666'; msg.style.fontSize = '1.10em';
        msg.innerHTML = 'Select one or more symbols above to view heatmaps.';
        heatmapsContainer.appendChild(msg); return;
      }
      let overallMaxH = -Infinity;
      selectedSymbols.forEach((symbol, plotIdx) => {
        const D = allData[symbol];
        if (!D) return;
        const floor = +arFloor.value, minMD = +mdMin.value, ceilMD = +mdCeil.value;

        // --- Get or set default colorbar min/max ---
        const colorbarMinKey = "colorbarMin-" + plotIdx, colorbarMaxKey = "colorbarMax-" + plotIdx;
        let zminVal = window[colorbarMinKey] !== undefined ? window[colorbarMinKey] : -2;
        let zmaxVal = window[colorbarMaxKey] !== undefined ? window[colorbarMaxKey] : 2;
        const H = computeH(D.ar, D.md, floor, minMD);
        const EPSILON = 1e-6;
        let mask;
        if (ceilMD <= EPSILON) mask = D.md.map(row => row.map(() => 1));
        else if (ceilMD >= 100 - EPSILON) mask = D.md.map(row => row.map(() => 0));
        else mask = D.md.map(row => row.map(v => (v != null && v > ceilMD) ? 1 : 0));
        let maxH = -Infinity;
        H.forEach(row => row.forEach(v => { if (v != null && v > maxH) maxH = v; }));
        if (maxH > overallMaxH) overallMaxH = maxH;
        // --- Heatmap section with floating Min/Max H input overlays ---
        const section = document.createElement('div');
        section.className = 'heatmap-section';
        section.innerHTML = `
        <div class="plot-container" style="position:relative;">
          <div id="heatmap-${plotIdx}" style="height: 55vh;"></div>
          <div class="colorbar-float" style="top:36px; right:23px;">
            <label class="colorbar-label-float">Max H</label>
            <input type="number" step="0.01" value="${zmaxVal}" id="colorbar-max-${plotIdx}" style="margin-bottom:3px;">
          </div>
          <div class="colorbar-float" style="bottom:13px; right:23px; flex-direction:column-reverse;">
            <input type="number" step="0.01" value="${zminVal}" id="colorbar-min-${plotIdx}" style="margin-top:3px;">
            <label class="colorbar-label-float colorbar-label-float-bottom">Min H</label>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.97em;margin-top:2px;">
          <span id="hoverX-${plotIdx}"></span>
          <span id="hoverY-${plotIdx}"></span>
        </div>`;
        heatmapsContainer.appendChild(section);

        // --- Plotly annotation for symbol (centered above plot) ---
        const heatDiv = section.querySelector(`#heatmap-${plotIdx}`);
        Plotly.newPlot(heatDiv, [
          {
            z: H, x: D.x, y: D.y, type: 'heatmap',
            colorscale: [[0, 'green'], [0.5, 'yellow'], [1, 'red']],
            zmin: zminVal, zmax: zmaxVal,
            colorbar: {
              thickness: 15, len: 0.90, x: 1.02, y: 0.5, tickfont: {size: 12},
              outlinewidth: 1, bordercolor: '#999'
            },
            customdata: D.ar.map((r, i) => r.map((_, j) => [D.ar[i][j], D.md[i][j], D.cm[i][j], H[i][j]])),
            hovertemplate: 'AR: %{customdata[0]:.2f}%<br>MD: %{customdata[1]:.2f}%<br>Calmar: %{customdata[2]:.2f}<br>H: %{customdata[3]:.3f}<extra></extra>'
          },
          {
            z: mask, x: D.x, y: D.y, type: 'heatmap', showscale: false,
            colorscale: [[0, 'rgba(0,0,0,0)'], [1, 'rgba(0,0,0,0.45)']], hoverinfo: 'skip'
          }
        ], {
          margin: { l: 45, r: 80, t: 65, b: 45 },
          xaxis: { title: 'RSI Threshold', tickfont: {size:12}, titlefont:{size:12} },
          yaxis: { title: 'Lookback (days)', tickfont: {size:12}, titlefont:{size:12} },
          annotations: [{
            text: symbol,
            font: { size: 14, family: 'inherit', color: '#134a7e', weight: 'bold' },
            showarrow: false,
            xref: 'paper', yref: 'paper', x: 0.5, y: 1.18, xanchor: 'center', yanchor: 'top'
          }]
        }, { responsive: true });

        // --- Colorbar Min/Max handlers ---
        setTimeout(() => {
          const minInput = document.getElementById(`colorbar-min-${plotIdx}`);
          const maxInput = document.getElementById(`colorbar-max-${plotIdx}`);
          minInput.onchange = function() { window[colorbarMinKey] = Number(minInput.value); drawHeatmaps(); };
          maxInput.onchange = function() { window[colorbarMaxKey] = Number(maxInput.value); drawHeatmaps(); };
        }, 0);

        // Crosshairs
        const hoverX = section.querySelector(`#hoverX-${plotIdx}`);
        const hoverY = section.querySelector(`#hoverY-${plotIdx}`);
        heatDiv.on('plotly_hover', function(eventData) {
          var pt = eventData.points[0];
          hoverX.innerText = 'RSI: ' + pt.x;
          hoverY.innerText = 'Day: ' + pt.y;
        });
        heatDiv.on('plotly_unhover', function() { hoverX.innerText = ''; hoverY.innerText = ''; });
      });
      if (overallMaxH === -Infinity) currentMaxH.textContent = 'Current Max H: --';
      else currentMaxH.textContent = 'Current Max H: ' + overallMaxH.toFixed(3);
    }
    // [Rest of your original JS stays the same: computeH, buildFromText, CSV, etc.]
  </script>
</body>
</html>
