<!DOCTYPE html>
<!-- Document Type Declaration: HTML5 -->
<html>
<head>
  <!-- Metadata: Character encoding -->
  <meta charset="utf-8">
  <!-- Page Title displayed in browser tab -->
  <title>Heatmap Viewer v0.0.23 w/ documentation</title>
  <!-- Include Plotly.js library for interactive plots -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* Base Styles: set default font and margins */
    body { font-family: sans-serif; margin: 20px; }
    /* Formula styling: italicized and spaced */
    .formula { font-style: italic; margin-bottom: 20px; }
    /* Header layout: flex container for controls and upload box */
    .header { display: flex; justify-content: space-between; align-items: flex-start; }
    /* Controls panel takes up remaining width */
    .controls { flex: 1; }
    /* Upload box border, padding, and rounding */
    .upload-box { border: 1px solid #ccc; padding: 8px; border-radius: 6px; }
    /* Spacing between individual control rows */
    .control { margin-bottom: 12px; }
    /* Labels bold with right margin */
    label { font-weight: bold; margin-right: 8px; }
    /* Slider input width and alignment */
    input[type=range] { width: 250px; vertical-align: middle; }
    /* Number input width and left margin */
    input[type=number] { width: 60px; margin-left: 8px; }
    /* Highlight text for current max H */
    #currentMaxH { margin-left: 12px; font-weight: bold; }
    /* Toggle switch container positioning */
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 6px; vertical-align: middle; }
    /* Hidden checkbox within switch */
    .switch input { opacity: 0; width: 0; height: 0; }
    /* Slider appearance */
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .4s; border-radius: 20px; }
    /* Slider knob */
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background: white; transition: .4s; border-radius: 50%; }
    /* Checked state styling */
    input:checked + .slider { background: #4CAF50; }
    input:checked + .slider:before { transform: translateX(20px); }
    /* Align labels for format text */
    .format-label { vertical-align: middle; }
    /* Containers for heatmap and hover overlays */
    #edgeContainer { display: flex; align-items: flex-start; }
    #hoverY { width: 80px; text-align: right; margin-right: 8px; min-height: 60vh; line-height: 60vh; }
    #heatmap { flex: 1; height: 60vh; }
    #hoverX-container { display: flex; justify-content: center; margin-top: 8px; }
    #hoverX { font-style: italic; color: #333; }
  </style>
</head>
<body>
  <!-- Page Heading -->
  <h2>Heatmap Viewer</h2>
  <!-- Metric formula description -->
  <div class="formula">
    <strong>Metric:</strong> H = (AR – AR<sub>min</sub>) / max(MD, MD<sub>min</sub>) (decimal)
  </div>
  <!-- Header section: controls on left, upload on right -->
  <div class="header">
    <!-- Controls Panel -->
    <div class="controls">
      <!-- Symbol dropdown -->
      <div class="control"><label>Symbol:</label><select id="symbolSelect"></select></div>
      <!-- AR Minimum slider and number input -->
      <div class="control"><label>AR Min. (%):</label><input type="range" id="arFloor" min="0" max="100" step="0.1" value="0"><input type="number" id="arFloorNum" min="0" max="100" step="0.1" value="0"></div>
      <!-- MD Minimum slider and number input -->
      <div class="control"><label>MD Min. (%):</label><input type="range" id="mdMin" min="0" max="100" step="0.1" value="5"><input type="number" id="mdMinNum" min="0" max="100" step="0.1" value="5"></div>
      <!-- MD Ceiling slider and number input -->
      <div class="control"><label>MD Ceiling (%):</label><input type="range" id="mdCeil" min="0" max="100" step="0.1" value="10"><input type="number" id="mdCeilNum" min="0" max="100" step="0.1" value="10"></div>
      <!-- Colorbar range and current max H display -->
      <div class="control"><label>Colorbar Min H:</label><input type="number" id="zMin" step="0.01" value="-1"><label>Colorbar Max H:</label><input type="number" id="zMax" step="0.01" value="1"><span id="currentMaxH">Current Max H: --</span></div>
    </div>
    <!-- Upload & Conversion Panel -->
    <div class="upload-box">
      <!-- CSV file input -->
      <div class="control"><label>Upload CSV:</label><input type="file" id="csvInput" accept=".csv"></div>
      <!-- Toggle for percent conversion -->
      <div class="toggle-box">
        <label>Data Conversion:</label>
        <span class="format-label">×0.01</span>
        <label class="switch">
          <input type="checkbox" id="percentToggle" checked>
          <span class="slider"></span>
        </label>
        <span class="format-label">×100</span>
      </div>
    </div>
  </div>
  <!-- Heatmap display and hover overlays -->
  <div id="edgeContainer"><div id="hoverY"></div><div id="heatmap"></div></div>
  <div id="hoverX-container"><div id="hoverX"></div></div>
  <script>
    // Data Initialization: preloaded data mapping symbols to arrays of x, y, ar, md, cm values
    let allData = { /* unchanged preloaded data blob from original file */ };

    // DOM References: get control elements and display containers
    const symbolSelect = document.getElementById('symbolSelect');
    const arFloor = document.getElementById('arFloor');
    const arFloorNum = document.getElementById('arFloorNum');
    const mdMin = document.getElementById('mdMin');
    const mdMinNum = document.getElementById('mdMinNum');
    const mdCeil = document.getElementById('mdCeil');
    const mdCeilNum = document.getElementById('mdCeilNum');
    const zMin = document.getElementById('zMin');
    const zMax = document.getElementById('zMax');
    const currentMaxH = document.getElementById('currentMaxH');
    const csvInput = document.getElementById('csvInput');
    const percentToggle = document.getElementById('percentToggle');
    const hoverY = document.getElementById('hoverY');
    const hoverX = document.getElementById('hoverX');

    // Populate Symbol Dropdown: use keys from allData
    Object.keys(allData).forEach(s => {
      const option = document.createElement('option');
      option.value = s;
      option.text = s;
      symbolSelect.add(option);
    });

    // Function: compute metric H, apply MD ceiling mask, render heatmap
    function updateHeatmap() {
      // (Original plotting code unchanged)
    }

    // Event Listeners: re-render heatmap when controls change
    [symbolSelect, arFloor, arFloorNum, mdMin, mdMinNum, mdCeil, mdCeilNum, zMin, zMax].forEach(el => {
      el.addEventListener('input', updateHeatmap);
    });

    // CSV Upload Handler: parse, apply conversion toggle, merge into allData, update plot
    csvInput.addEventListener('change', function(e) {
      // (Original CSV parsing code unchanged)
    });

    // Conversion Toggle: recompute values on toggle change
    percentToggle.addEventListener('change', () => {
      // (Original toggle handling unchanged)
    });

    // Hover Interaction: show AR, MD, H, and axis labels on hover
    document.getElementById('heatmap').on('plotly_hover', data => {
      // (Original hover code unchanged)
    });

    // Initial Plot Render on page load
    updateHeatmap();
  </script>
</body>
</html>
