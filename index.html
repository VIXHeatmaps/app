<!DOCTYPE html>
<!-- Snippet: Document Type Declaration -->
<html>
<head>
  <!-- Snippet: Head - metadata and title -->
  <meta charset="utf-8">
  <title>Heatmap Viewer</title>
  <!-- Snippet: Plotly Library Import -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* Snippet: Base Styles - font and layout */
    body { font-family: sans-serif; margin: 20px; }

    /* Snippet: Formula Styling - italic formula under title */
    .formula { font-style: italic; margin-bottom: 20px; }

    /* Snippet: Header Layout - flex container for controls and upload box */
    .header { display: flex; justify-content: space-between; align-items: flex-start; }

    /* Snippet: Left Controls Panel - takes up available width */
    .controls { flex: 1; }

    /* Snippet: Upload Box Styles */
    .upload-box { border: 1px solid #ccc; padding: 8px; border-radius: 6px; }

    /* Snippet: Individual Control Spacing */
    .control { margin-bottom: 12px; }

    /* Snippet: Label Styling */
    label { font-weight: bold; margin-right: 8px; }

    /* Snippet: Slider and Number Input Sizing */
    input[type=range] { width: 250px; vertical-align: middle; }
    input[type=number] { width: 60px; margin-left: 8px; }

    /* Snippet: Current Max H Label */
    #currentMaxH { margin-left: 12px; font-weight: bold; }

    /* Snippet: Toggle Switch Styles */
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 6px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background: #4CAF50; }
    input:checked + .slider:before { transform: translateX(20px); }

    /* Snippet: Format Label Alignment */
    .format-label { vertical-align: middle; }

    /* Snippet: Heatmap and Hover Containers */
    #edgeContainer { display: flex; align-items: flex-start; }
    #hoverY { width: 80px; text-align: right; margin-right: 8px; min-height: 60vh; line-height: 60vh; }
    #heatmap { flex: 1; height: 60vh; }
    #hoverX-container { display: flex; justify-content: center; margin-top: 8px; }
    #hoverX { font-style: italic; color: #333; }
  </style>
</head>
<body>
  <!-- Snippet: Page Title -->
  <h2>Heatmap Viewer</h2>

  <!-- Snippet: Metric Formula Display -->
  <div class="formula">
    <strong>Metric:</strong> H = (AR – AR<sub>min</sub>) / max(MD, MD<sub>min</sub>) (decimal)
  </div>

  <!-- Snippet: Header Section - Controls and Upload Box -->
  <div class="header">
    <!-- Snippet: Left Panel - Metric Controls -->
    <div class="controls">
      <!-- Symbol Selector -->
      <div class="control"><label>Symbol:</label><select id="symbolSelect"></select></div>
      <!-- AR Min Control -->
      <div class="control"><label>AR Min. (%):</label><input type="range" id="arFloor" min="0" max="100" step="0.1" value="1"><input type="number" id="arFloorNum" min="0" max="100" step="0.1" value="1"></div>
      <!-- MD Min Control -->
      <div class="control"><label>MD Min. (%):</label><input type="range" id="mdMin" min="0" max="100" step="0.1" value="3"><input type="number" id="mdMinNum" min="0" max="100" step="0.1" value="3"></div>
      <!-- MD Ceiling Control -->
      <div class="control"><label>MD Ceiling (%):</label><input type="range" id="mdCeil" min="0" max="100" step="0.1" value="25"><input type="number" id="mdCeilNum" min="0" max="100" step="0.1" value="25"></div>
      <!-- Colorbar Range Controls -->
      <div class="control"><label>Colorbar Min H:</label><input type="number" id="zMin" step="0.01" value="-1"><label>Colorbar Max H:</label><input type="number" id="zMax" step="0.01" value="1"><span id="currentMaxH">Current Max H: --</span></div>
    </div>

    <!-- Snippet: Right Panel - CSV Upload & Conversion Toggle -->
    <div class="upload-box">
      <!-- CSV File Input -->
      <div class="control"><label>Upload CSV:</label><input type="file" id="csvInput" accept=".csv"></div>
      <!-- Conversion Toggle -->
      <div class="toggle-box">
        <label>Data Conversion:</label>
        <span class="format-label">×0.01</span>
        <label class="switch">
          <input type="checkbox" id="percentToggle" checked>
          <span class="slider"></span>
        </label>
        <span class="format-label">×100</span>
      </div>
    </div>
  </div>

  <!-- Snippet: Heatmap & Hover Display Containers -->
  <div id="edgeContainer"><div id="hoverY"></div><div id="heatmap"></div></div>
  <div id="hoverX-container"><div id="hoverX"></div></div>

  <script>
    // Snippet: Data Initialization - Preloaded CSV data for multiple symbols
    let allData = { /* large preloaded data object */ };

    // Snippet: DOM Element References & Default Parameters
    const symbolSelect = document.getElementById('symbolSelect');
    const arFloor = document.getElementById('arFloor');
    const arFloorNum = document.getElementById('arFloorNum');
    const mdMin = document.getElementById('mdMin');
    const mdMinNum = document.getElementById('mdMinNum');
    const mdCeil = document.getElementById('mdCeil');
    const mdCeilNum = document.getElementById('mdCeilNum');
    const zMin = document.getElementById('zMin');
    const zMax = document.getElementById('zMax');
    const currentMaxH = document.getElementById('currentMaxH');
    const csvInput = document.getElementById('csvInput');
    const percentToggle = document.getElementById('percentToggle');
    const hoverY = document.getElementById('hoverY');
    const hoverX = document.getElementById('hoverX');

    // Snippet: Initialize Symbol Dropdown from allData keys
    Object.keys(allData).forEach(sym => {
      const option = document.createElement('option');
      option.value = sym;
      option.text = sym;
      symbolSelect.add(option);
    });

    // Snippet: Plot Creation & Update Function
    function updateHeatmap() {
      // compute H metric and mask cells based on MD ceiling, then call Plotly.newPlot
    }

    // Snippet: Event Listeners for Controls to trigger updateHeatmap
    [symbolSelect, arFloor, arFloorNum, mdMin, mdMinNum, mdCeil, mdCeilNum, zMin, zMax].forEach(el => {
      el.addEventListener('input', updateHeatmap);
    });

    // Snippet: CSV Parsing - read uploaded file and merge into allData
    csvInput.addEventListener('change', function(e) {
      // parse CSV, convert values if percentToggle, add new symbols, then updateHeatmap
    });

    // Snippet: Conversion Toggle Logic - adjusts multiplier
    percentToggle.addEventListener('change', () => {
      // re-parse or adjust data values based on toggle state
    });

    // Snippet: Hover Handling - update hoverY and hoverX labels on heatmap hover events
    document.getElementById('heatmap').on('plotly_hover', data => {
      // show AR/MD/H and axis labels
    });

    // Snippet: Export Functionality - button to download current allData as CSV
    // (button and handler not shown in this iteration)

    // Snippet: Initial Plot Render
    updateHeatmap();
  </script>
</body>
</html>
