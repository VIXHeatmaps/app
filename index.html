<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Heatmap Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .header { display: flex; justify-content: space-between; align-items: flex-start; }
    .controls { flex: 1; }
    .right-controls {
      min-width: 350px;
      margin-top: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .rc-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .rc-row label {
      font-weight: bold;
    }
    .csv-link {
      color: #0074d9;
      text-decoration: underline;
      cursor: pointer;
      font-weight: 600;
      margin: 0 3px;
      font-size: 1em;
    }
    .export-btn {
      background: #1884f7;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 22px;
      font-size: 1em;
      cursor: pointer;
      margin-top: 0;
      font-weight: 500;
      transition: background 0.13s;
    }
    .export-btn:hover {
      background: #0059b2;
    }
    .select-note {
      font-size: 0.99em;
      color: #189c2f;
      margin-left: 7px;
    }
    /* Small modal for CSV template */
    #csvModal {
      display: none;
      position: fixed;
      z-index: 12;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.2);
      align-items: center;
      justify-content: center;
    }
    #csvModal .modal-content {
      background: #fff;
      border-radius: 7px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.13);
      padding: 22px 36px 18px 36px;
      min-width: 340px;
      max-width: 94vw;
      min-height: 50px;
      font-size: 1.02em;
    }
    #csvModal table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
      background: #fcfcfc;
    }
    #csvModal th, #csvModal td {
      border: 1px solid #d6d6d6;
      padding: 5px 14px;
      text-align: center;
    }
    #csvModal th {
      background: #f7f7f9;
      font-weight: bold;
    }
    #closeModalBtn {
      float: right;
      margin-top: -18px;
      margin-right: -12px;
      border: none;
      background: none;
      font-size: 1.5em;
      color: #888;
      cursor: pointer;
    }
    #closeModalBtn:hover { color: #333; }
    /* Heatmap spacing */
    #edgeContainer { display: flex; align-items: flex-start; }
    #hoverY { width: 80px; text-align: right; margin-right: 8px; min-height: 60vh; line-height: 60vh; }
    #heatmap { flex: 1; height: 60vh; }
    #hoverX-container { display: flex; justify-content: center; margin-top: 8px; }
    #hoverX { font-style: italic; color: #333; }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div class="controls">
      <div style="font-size: 1.17em; font-style: italic; margin-bottom: 14px;">
        <b>Metric:</b> H = (AR – AR<sub>min</sub>) / max(MD, MD<sub>min</sub>) <span style="font-size: 0.96em;">(decimal)</span>
      </div>
      <div style="font-weight:bold; margin-bottom:6px;">
        Symbol:
        <select id="symbolSelect"></select>
        <button id="clearDataBtn" style="margin-left:10px; font-size:0.98em;">Clear Data</button>
      </div>
      <div><b>AR Min. (%):</b>
        <input type="range" id="arFloor" min="0" max="100" step="0.1" value="3" style="width:180px;vertical-align:middle;">
        <input type="number" id="arFloorNum" min="0" max="100" step="0.1" value="3" style="width:50px;">
      </div>
      <div><b>MD Min. (%):</b>
        <input type="range" id="mdMin" min="0" max="100" step="0.1" value="5" style="width:180px;vertical-align:middle;">
        <input type="number" id="mdMinNum" min="0" max="100" step="0.1" value="5" style="width:50px;">
      </div>
      <div><b>MD Max (%):</b>
        <input type="range" id="mdCeil" min="0" max="100" step="0.1" value="50" style="width:180px;vertical-align:middle;">
        <input type="number" id="mdCeilNum" min="0" max="100" step="0.1" value="50" style="width:50px;">
      </div>
      <div style="margin-top: 6px;">
        <b>Colorbar Min H:</b> <input type="number" id="zMin" step="0.01" value="-1" style="width:48px;">
        <b style="margin-left:6px;">Colorbar Max H:</b> <input type="number" id="zMax" step="0.01" value="1" style="width:48px;">
        <span id="currentMaxH" style="font-weight: bold; margin-left:12px;">Current Max H: --</span>
      </div>
    </div>
    <div class="right-controls">
      <div class="rc-row">
        <label for="dataSourceSelect">Data Source:</label>
        <select id="dataSourceSelect">
          <option>Exxahub</option>
          <option>Testfol.io</option>
          <option>Composer</option>
          <option>Quantmage</option>
          <option>Other</option>
        </select>
      </div>
      <div class="rc-row">
        <input type="checkbox" id="decimalToPercentBox">
        <label for="decimalToPercentBox" style="font-weight:normal; margin-left:2px;">Decimal → %</label>
        <span class="select-note">(select prior to upload)</span>
      </div>
      <div class="rc-row">
        <label style="font-weight: bold;">Upload <span class="csv-link" id="showCsvTemplate">CSV</span>:</label>
        <input type="file" id="csvInput" accept=".csv">
      </div>
      <button id="exportCSVBtn" class="export-btn">Download Data</button>
    </div>
  </div>

  <!-- CSV Modal -->
  <div id="csvModal">
    <div class="modal-content">
      <button id="closeModalBtn" title="Close">&times;</button>
      <div style="font-weight: bold; margin-bottom: 8px;">CSV Upload Template</div>
      <table>
        <tr>
          <th>Symbol</th>
          <th>Days</th>
          <th>RSI</th>
          <th>AR</th>
          <th>MD</th>
        </tr>
        <tr>
          <td>TQQQ</td>
          <td>9</td>
          <td>82</td>
          <td>13.59%</td>
          <td>9.63%</td>
        </tr>
      </table>
      <div style="color: #008000; font-size: 0.98em; margin-top: 6px;">
        ✓ Use these exact headers (<b>column order doesn't matter</b>)
      </div>
      <div style="margin-top:10px; color:#444;">
        You may also use: <b>Ticker</b>, <b>Name</b> for Symbol; <b>Lookback</b>, <b>Window</b> for Days; <b>Drawdown</b> for MD, <b>CAGR</b> for AR, etc.
      </div>
    </div>
  </div>

  <div id="edgeContainer"><div id="hoverY"></div><div id="heatmap"></div></div>
  <div id="hoverX-container"><div id="hoverX"></div></div>

  <script>
    // CSV MODAL LOGIC
    document.getElementById('showCsvTemplate').onclick = function() {
      document.getElementById('csvModal').style.display = 'flex';
    };
    document.getElementById('closeModalBtn').onclick = function() {
      document.getElementById('csvModal').style.display = 'none';
    };
    window.onclick = function(event) {
      if (event.target === document.getElementById('csvModal')) {
        document.getElementById('csvModal').style.display = 'none';
      }
    };

    let allData = {};
    let rawText = null;
    const csvInput = document.getElementById('csvInput'),
          symbolSelect = document.getElementById('symbolSelect'),
          arFloor = document.getElementById('arFloor'),
          arFloorNum = document.getElementById('arFloorNum'),
          mdMin = document.getElementById('mdMin'),
          mdMinNum = document.getElementById('mdMinNum'),
          mdCeil = document.getElementById('mdCeil'),
          mdCeilNum = document.getElementById('mdCeilNum'),
          zMin = document.getElementById('zMin'),
          zMax = document.getElementById('zMax'),
          hoverX = document.getElementById('hoverX'),
          hoverY = document.getElementById('hoverY'),
          currentMaxH = document.getElementById('currentMaxH'),
          heatDiv = document.getElementById('heatmap'),
          dataSourceSelect = document.getElementById('dataSourceSelect'),
          clearDataBtn = document.getElementById('clearDataBtn'),
          decimalToPercentBox = document.getElementById('decimalToPercentBox'),
          exportCSVBtn = document.getElementById('exportCSVBtn');

    // CLEAR DATA BUTTON
    clearDataBtn.addEventListener('click', () => {
      allData = {};
      symbolSelect.innerHTML = '';
      Plotly.purge(heatDiv);
      hoverX.innerText = '';
      hoverY.innerText = '';
      currentMaxH.textContent = 'Current Max H: --';
    });

    // AUTOLOAD CSV ON PAGE LOAD (default source = "Exxahub")
    window.addEventListener('DOMContentLoaded', () => {
      fetch('data/LoadDataTQQQ.csv')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.text();
        })
        .then(csvText => {
          rawText = csvText;
          buildFromText(csvText, "Exxahub");
          populateSymbols();
        })
        .catch(error => {
          console.log('Autoload CSV error:', error);
        });
    });

    function populateSymbols() {
      symbolSelect.innerHTML = '';
      Object.keys(allData).forEach(s => {
        const opt = document.createElement('option');
        opt.value = opt.text = s;
        symbolSelect.appendChild(opt);
      });
      if (symbolSelect.options.length) {
        symbolSelect.selectedIndex = 0;
        drawHeatmap();
      }
    }

    csvInput.addEventListener('change', e => {
      const reader = new FileReader();
      reader.onload = evt => {
        rawText = evt.target.result;
        let source = dataSourceSelect.value;
        buildFromText(rawText, source);
        populateSymbols();
      };
      reader.readAsText(e.target.files[0]);
    });

    [arFloor, arFloorNum].forEach(el => el.oninput = () => {
      arFloor.value = arFloorNum.value = el.value;
      drawHeatmap();
    });
    [mdMin, mdMinNum].forEach(el => el.oninput = () => {
      mdMin.value = mdMinNum.value = el.value;
      drawHeatmap();
    });
    [mdCeil, mdCeilNum].forEach(el => el.oninput = () => {
      mdCeil.value = mdCeilNum.value = el.value;
      drawHeatmap();
    });
    [zMin, zMax].forEach(el => el.oninput = drawHeatmap);
    symbolSelect.onchange = drawHeatmap;

    // Accepts new param: source
    function buildFromText(text, source) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return;

      const headerMap = {
        symbol: ['symbol', 'ticker', 'name'],
        day: ['day', 'days', 'timeframe', 'window', 'period', 'lookback'],
        rsi: ['rsi', 'relative strength index'],
        ar: ['ar', 'annualized return', 'cagr'],
        md: ['md', 'max drawdown', 'drawdown']
      };

      function findCol(headers, aliases) {
        for (let i = 0; i < headers.length; ++i) {
          const h = headers[i].trim().toLowerCase();
          if (aliases.includes(h)) return i;
        }
        return -1;
      }

      const headers = lines[0].split(',');
      const colIdx = {};
      Object.keys(headerMap).forEach(key => {
        const idx = findCol(
          headers,
          headerMap[key].map(s => s.toLowerCase())
        );
        if (idx === -1) {
          throw new Error(`Missing column for ${key} (${headerMap[key].join('/')})`);
        }
        colIdx[key] = idx;
      });

      // Store per-symbol per-source
      const temp = {};

      for (let i = 1; i < lines.length; ++i) {
        const c = lines[i].split(',');
        if (c.length < headers.length) continue;
        const symSource = c[colIdx.symbol] + " (" + source + ")";
        const d = +c[colIdx.day];
        const x = c[colIdx.rsi];
        let ar = parseFloat(c[colIdx.ar]), md = parseFloat(c[colIdx.md]);
        // Convert decimals to percent if checked
        if (decimalToPercentBox && decimalToPercentBox.checked) {
          ar *= 100;
          md *= 100;
        }
        const cm = (md === 0 ? null : ar / md);
        temp[symSource] = temp[symSource] || [];
        temp[symSource].push({ day: d, rsi: x, ar, md, cm });
      }

      // Merge into allData
      Object.keys(temp).forEach(s => {
        const arr = temp[s];
        const xs = Array.from(new Set(arr.map(o => o.rsi))).sort();
        const ys = Array.from(new Set(arr.map(o => o.day))).sort((a, b) => a - b);
        const arM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.ar : null;
        }));
        const mdM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.md : null;
        }));
        const cmM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.cm : null;
        }));
        allData[s] = { x: xs, y: ys, ar: arM, md: mdM, cm: cmM };
      });
    }

    // All slider logic now uses raw percent units
    function computeH(ar, md, floor, minMD) {
      return ar.map((row, i) => row.map((v, j) => {
        if (v == null) return null;
        return (v - floor) / Math.max(md[i][j], minMD);
      }));
    }

    // FULL DRAWHEATMAP FUNCTION
    function drawHeatmap() {
      const s = symbolSelect.value;
      if (!s) return;
      const D = allData[s];
      const floor = +arFloor.value;
      const minMD = +mdMin.value;
      const ceilMD = +mdCeil.value;
      const zminVal = +zMin.value;
      const zmaxVal = +zMax.value;
      const H = computeH(D.ar, D.md, floor, minMD);

      // MD ceiling mask: at 0 mask everything, at 100 mask nothing, in between mask values above slider.
      const EPSILON = 1e-6;
      let mask;
      if (ceilMD <= EPSILON) {
        mask = D.md.map(row => row.map(() => 1));
      } else if (ceilMD >= 100 - EPSILON) {
        mask = D.md.map(row => row.map(() => 0));
      } else {
        mask = D.md.map(row => row.map(v => (v != null && v > ceilMD) ? 1 : 0));
      }

      // Compute current max H
      let maxH = -Infinity;
      H.forEach(row => row.forEach(v => { if (v != null && v > maxH) maxH = v; }));
      currentMaxH.textContent = 'Current Max H: ' + maxH.toFixed(3);

      Plotly.newPlot(heatDiv, [
        {
          z: H,
          x: D.x,
          y: D.y,
          type: 'heatmap',
          colorscale: [[0, 'green'], [0.5, 'yellow'], [1, 'red']],
          zmin: zminVal,
          zmax: zmaxVal,
          customdata: D.ar.map((r, i) => r.map((_, j) => [D.ar[i][j], D.md[i][j], D.cm[i][j], H[i][j]])),
          hovertemplate: 'AR: %{customdata[0]:.2f}%<br>MD: %{customdata[1]:.2f}%<br>Calmar: %{customdata[2]:.2f}<br>H: %{customdata[3]:.3f}<extra></extra>'
        },
        {
          z: mask,
          x: D.x,
          y: D.y,
          type: 'heatmap',
          showscale: false,
          colorscale: [[0, 'rgba(0,0,0,0)'], [1, 'rgba(0,0,0,0.5)']],
          hoverinfo: 'skip'
        }
      ], {
        margin: { l: 60, r: 60, t: 60, b: 60 },
        xaxis: { title: 'RSI Threshold' },
        yaxis: { title: 'Lookback (days)' }
      }, { responsive: true });

      // Edge labels on hover
      heatDiv.on('plotly_hover', function(eventData) {
        var pt = eventData.points[0];
        document.getElementById('hoverX').innerText = 'RSI: ' + pt.x;
        document.getElementById('hoverY').innerText = 'Day: ' + pt.y;
      });
      heatDiv.on('plotly_unhover', function() {
        document.getElementById('hoverX').innerText = '';
        document.getElementById('hoverY').innerText = '';
      });
    }

    // ---- CSV Export Functionality ----
    exportCSVBtn.addEventListener('click', function() {
      // Get slider values
      const floor = +arFloor.value;
      const minMD = +mdMin.value;
      const ceilMD = +mdCeil.value;
      const hColName = `H (Rmin${floor}|Dmin${minMD}|Dmax${ceilMD})`;

      // CSV Header
      let csv = `Symbol,Days,RSI,AR,MD,Calmar,${hColName}\n`;
      Object.keys(allData).forEach(symbol => {
        const D = allData[symbol];
        const H = computeH(D.ar, D.md, floor, minMD);
        for (let i = 0; i < D.y.length; ++i) {
          for (let j = 0; j < D.x.length; ++j) {
            if (D.ar[i][j] == null) continue;
            csv += [
              `"${symbol}"`,
              D.y[i],
              D.x[j],
              D.ar[i][j],
              D.md[i][j],
              (D.cm[i][j] == null ? "" : D.cm[i][j]),
              (H[i][j] == null ? "" : H[i][j].toFixed(5))
            ].join(",") + "\n";
          }
        }
      });
      // Download
      const blob = new Blob([csv], {type: "text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "merged_heatmap_data.csv";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }, 0);
    });
  </script>
</body>
</html>
