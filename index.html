// 5.10: Draw Heatmaps (vertically centered Days label/value at y-axis)
function drawHeatmaps() {
  heatmapsContainer.innerHTML = '';
  if (!selectedSymbols.length) {
    currentMaxH.textContent = 'Current Max H: --';
    const msg = document.createElement('div');
    msg.style.textAlign = 'center';
    msg.style.margin = '30px 0 30px 0';
    msg.style.color = '#666';
    msg.style.fontSize = '1.10em';
    msg.innerHTML = 'Select one or more symbols above to view heatmaps.';
    heatmapsContainer.appendChild(msg);
    return;
  }
  let overallMaxH = -Infinity;
  selectedSymbols.forEach((symbolSource, plotIdx) => {
    const match = symbolSource.match(/^(.*) \((.*)\)$/);
    if (!match) return;
    const symbol = match[1];
    const source = match[2];
    const rows = window.allData.filter(r => r.symbol === symbol && r.source === source);
    if (!rows.length) return;
    const xs = Array.from(new Set(rows.map(r => r.rsi))).sort((a, b) => +a - +b);
    const ys = Array.from(new Set(rows.map(r => r.day))).sort((a, b) => +a - +b);
    const arM = ys.map(y => xs.map(x => {
      const rec = rows.find(r => r.day === y && r.rsi === x);
      return rec ? rec.ar : null;
    }));
    const mdM = ys.map(y => xs.map(x => {
      const rec = rows.find(r => r.day === y && r.rsi === x);
      return rec ? rec.md : null;
    }));
    const cmM = ys.map(y => xs.map(x => {
      const rec = rows.find(r => r.day === y && r.rsi === x);
      return rec ? rec.cm : null;
    }));
    const floor = +arFloor.value;
    const minMD = +mdMin.value;
    const ceilMD = +mdCeil.value;
    const colorbarMinKey = "colorbarMin-" + plotIdx;
    const colorbarMaxKey = "colorbarMax-" + plotIdx;
    let zminVal = window[colorbarMinKey] !== undefined ? window[colorbarMinKey] : -1;
    let zmaxVal = window[colorbarMaxKey] !== undefined ? window[colorbarMaxKey] : 1;
    const H = computeH(arM, mdM, floor, minMD);
    const EPSILON = 1e-6;
    let mask;
    if (ceilMD <= EPSILON) mask = mdM.map(row => row.map(() => 1));
    else if (ceilMD >= 100 - EPSILON) mask = mdM.map(row => row.map(() => 0));
    else mask = mdM.map(row => row.map(v => (v != null && v > ceilMD) ? 1 : 0));
    let maxH = -Infinity;
    H.forEach(row => row.forEach(v => { if (v != null && v > maxH) maxH = v; }));
    if (maxH > overallMaxH) overallMaxH = maxH;

    // Layout: Fund name between ticker/source and heatmap
    const fundName = tickerNameMap[symbol] || "";
    // Outer container = relative
    const section = document.createElement('div');
    section.className = 'heatmap-section';
    section.style.position = "relative";
    section.innerHTML = `
      <div id="heatmap-title-${plotIdx}" style="text-align:center;">
        <div style="font-size:18px;color:#1b365d;font-weight:500;margin-bottom:0px;">${symbolSource}</div>
        ${fundName ? `<div style="font-size:12px; color:#2e4057; margin-top:2px; margin-bottom:10px;">${fundName}</div>` : ""}
      </div>
      <div style="display:flex; flex-direction:row; align-items:stretch; position:relative;">
        <div id="yHoverBox-${plotIdx}" style="
            position:absolute;
            left:0; 
            top:0; 
            bottom:0; 
            width:38px; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            justify-content:center; 
            z-index:2;">
          <span id="hoverYValue-${plotIdx}" 
                style="font-size:18px; font-weight:700; color:#253358; min-height:24px; writing-mode:vertical-lr; transform: rotate(180deg); text-align:center;"></span>
          <span style="font-size:16px; font-weight:bold; color:#1b365d; writing-mode:vertical-lr; transform: rotate(180deg); text-align:center; margin-top:2px;">Days</span>
        </div>
        <div style="flex:1; margin-left:38px;">
          <div id="heatmap-${plotIdx}" style="height: 56vh;"></div>
          <div class="colorbar-input-container" style="top: 2px;" id="colorbar-max-container-${plotIdx}">
            <span class="colorbar-label">Max H</span>
            <input type="number" step="0.01" value="${zmaxVal}" id="colorbar-max-${plotIdx}" class="colorbar-input">
          </div>
          <div class="colorbar-input-container" style="bottom: 16px; top:unset;" id="colorbar-min-container-${plotIdx}">
            <span class="colorbar-label">Min H</span>
            <input type="number" step="0.01" value="${zminVal}" id="colorbar-min-${plotIdx}" class="colorbar-input">
          </div>
        </div>
      </div>
      <div style="display: flex; flex-direction:column; align-items:center; margin-top:2px;">
        <span style="font-size:13px; color:#3e5678; margin-bottom:0;">RSI</span>
        <span id="hoverXValue-${plotIdx}" style="font-size:16px; font-weight:bold; color:#253358; min-height:22px;"></span>
      </div>
    `;
    heatmapsContainer.appendChild(section);

    // --- Main heatmap plot
    const heatDiv = section.querySelector(`#heatmap-${plotIdx}`);
    Plotly.newPlot(heatDiv, [
      {
        z: H, x: xs, y: ys, type: 'heatmap',
        colorscale: [[0, 'green'], [0.5, 'yellow'], [1, 'red']],
        zmin: zminVal, zmax: zmaxVal,
        colorbar: {
          thickness: 15, len: 0.92, x: 1.01, y: 0.5, tickfont: {size: 12}
        },
        customdata: arM.map((r, i) => r.map((_, j) => [arM[i][j], mdM[i][j], cmM[i][j], H[i][j]])),
        hovertemplate: 'AR: %{customdata[0]:.2f}%<br>MD: %{customdata[1]:.2f}%<br>Calmar: %{customdata[2]:.2f}<br>H: %{customdata[3]:.3f}<extra></extra>'
      },
      {
        z: mask, x: xs, y: ys, type: 'heatmap', showscale: false,
        colorscale: [[0, 'rgba(0,0,0,0)'], [1, 'rgba(0,0,0,0.45)']], hoverinfo: 'skip'
      }
    ], {
      margin: { l: 30, r: 65, t: 15, b: 45 },
      xaxis: { title: '', tickfont: {size:12}, titlefont:{size:12} },
      yaxis: { title: '', tickfont: {size:12}, titlefont:{size:12} },
      annotations: []
    }, { responsive: true });

    // --- Colorbar min/max event handlers
    setTimeout(() => {
      const minInput = document.getElementById(`colorbar-min-${plotIdx}`);
      const maxInput = document.getElementById(`colorbar-max-${plotIdx}`);
      minInput.onchange = function() {
        window[colorbarMinKey] = Number(minInput.value);
        drawHeatmaps();
      };
      maxInput.onchange = function() {
        window[colorbarMaxKey] = Number(maxInput.value);
        drawHeatmaps();
      };
    }, 0);

    // --- Custom crosshair values (RSI and Days)
    const hoverX = section.querySelector(`#hoverXValue-${plotIdx}`);
    const hoverY = section.querySelector(`#hoverYValue-${plotIdx}`);

    heatDiv.on('plotly_hover', function(eventData) {
      var pt = eventData.points[0];
      hoverX.innerText = pt.x;
      hoverY.innerText = pt.y;
    });
    heatDiv.on('plotly_unhover', function() {
      hoverX.innerText = '';
      hoverY.innerText = '';
    });
  });
  if (overallMaxH === -Infinity) currentMaxH.textContent = 'Current Max H: --';
  else currentMaxH.textContent = 'Current Max H: ' + overallMaxH.toFixed(3);
}
