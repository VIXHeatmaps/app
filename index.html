<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Heatmap Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 14px; }
    .formula { font-style: italic; font-size: 1.05em; margin-bottom: 8px; font-weight: normal; }
    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0; }
    .controls { flex: 1; }
    .right-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-left: 32px;
      margin-top: 0;
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0;
    }
    .right-row { display: flex; align-items: center; gap: 14px; margin-bottom: 4px; }
    .right-label { font-weight: bold; }
    .readme-link {
      color: #1a7af6;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
      margin-left: 2px;
      font-size: 1em;
    }
    /* Minimal control style */
    .control { margin-bottom: 6px; }
    label { font-weight: bold; margin-right: 8px; }
    input[type=range] { width: 200px; vertical-align: middle; }
    input[type=number], select { width: 54px; margin-left: 5px; }
    #currentMaxH { margin-left: 12px; font-weight: bold; }
    #edgeContainer { display: flex; align-items: flex-start; }
    #hoverY { width: 80px; text-align: right; margin-right: 8px; min-height: 60vh; line-height: 60vh; }
    #heatmap { flex: 1; height: 60vh; }
    #hoverX-container { display: flex; justify-content: center; margin-top: 8px; }
    #hoverX { font-style: italic; color: #333; }

    /* Minimal file input, button blue style */
    .file-btn {
      display: inline-block;
      padding: 4px 20px;
      font-size: 0.92em;
      font-family: inherit;
      color: #fff;
      background: #1a7af6;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.1s;
      margin-left: 10px;
    }
    .file-btn:hover, .file-btn:focus {
      background: #155db2;
    }
    /* Remove outline from right section (no border) */
    .no-border {
      border: none !important;
      background: none !important;
      box-shadow: none !important;
    }
    /* Inline labels for upload/export */
    .inline-label {
      font-weight: bold;
      margin-right: 5px;
      font-size: 1em;
    }
    .csv-link {
      color: #1a7af6;
      text-decoration: underline;
      font-weight: bold;
      font-size: 1em;
      cursor: pointer;
      border: none;
      background: none;
      margin: 0 2px;
      padding: 0;
    }
    @media (max-width: 900px) {
      .header { flex-direction: column; }
      .right-controls { align-items: flex-start; margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="formula" style="margin-top:0;">
    <span style="font-style: italic;">Metric: <span style="font-style:normal;">H = (AR – AR<sub>min</sub>) / max(MD, MD<sub>min</sub>) (decimal)</span></span>
  </div>
  <div class="header">
    <div class="controls">
      <div class="control" style="display: flex; align-items: center;">
        <label>Symbol:</label>
        <select id="symbolSelect"></select>
        <button id="clearDataBtn" style="margin-left:8px;">Clear Data</button>
      </div>
      <div class="control"><label>AR Min. (%):</label>
        <input type="range" id="arFloor" min="0" max="100" step="0.1" value="3">
        <input type="number" id="arFloorNum" min="0" max="100" step="0.1" value="3">
      </div>
      <div class="control"><label>MD Min. (%):</label>
        <input type="range" id="mdMin" min="0" max="100" step="0.1" value="5">
        <input type="number" id="mdMinNum" min="0" max="100" step="0.1" value="5">
      </div>
      <div class="control"><label>MD Max (%):</label>
        <input type="range" id="mdCeil" min="0" max="100" step="0.1" value="50">
        <input type="number" id="mdCeilNum" min="0" max="100" step="0.1" value="50">
      </div>
      <div class="control">
        <label>Colorbar Min H:</label>
        <input type="number" id="zMin" step="0.01" value="-1">
        <label>Colorbar Max H:</label>
        <input type="number" id="zMax" step="0.01" value="1">
        <span id="currentMaxH">Current Max H: --</span>
      </div>
    </div>
    <div class="right-controls no-border">
      <div class="right-row">
        <span class="right-label">Data Source:</span>
        <select id="dataSourceSelect">
          <option>Exxahub</option>
          <option>Testfol.io</option>
          <option>Composer</option>
          <option>Quantmage</option>
          <option>Other</option>
        </select>
        <input type="checkbox" id="decimalToPercentBox" style="margin-left:8px;">
        <span style="font-weight:bold;">Decimal → %</span>
        <span style="color: #129400; font-size:1em; margin-left:2px;">(select prior to upload)</span>
      </div>
      <div class="right-row">
        <span class="inline-label">Upload CSV:</span>
        <input type="file" id="csvInput" accept=".csv">
        <button id="exportCSVBtn" class="file-btn">
          Export <a href="#" id="csvTemplateLink" class="csv-link" tabindex="-1">CSV</a>
        </button>
      </div>
      <input type="text" id="otherSourceBox" placeholder="Type here" style="display:none; margin-top:5px; width: 100px;" />
    </div>
  </div>
  <div id="edgeContainer"><div id="hoverY"></div><div id="heatmap"></div></div>
  <div id="hoverX-container"><div id="hoverX"></div></div>

  <!-- CSV Template Modal (hidden by default, pure HTML, appears on CSV link click) -->
  <div id="csvModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.14); z-index:50;">
    <div style="background:white; border-radius:7px; max-width:420px; margin:80px auto; padding:26px 32px 20px 32px; box-shadow:0 2px 24px rgba(60,60,60,.10);">
      <div style="font-weight: bold; font-size:1.12em; margin-bottom: 8px;">CSV Template Required:</div>
      <table style="border-collapse: collapse; width: 100%; background: white; border: 1px solid #e1e4e8;">
        <tr>
          <th style="border: 1px solid #e1e4e8; padding: 5px 14px; background: #f6f8fa;">Symbol</th>
          <th style="border: 1px solid #e1e4e8; padding: 5px 14px; background: #f6f8fa;">Days</th>
          <th style="border: 1px solid #e1e4e8; padding: 5px 14px; background: #f6f8fa;">RSI</th>
          <th style="border: 1px solid #e1e4e8; padding: 5px 14px; background: #f6f8fa;">AR</th>
          <th style="border: 1px solid #e1e4e8; padding: 5px 14px; background: #f6f8fa;">MD</th>
        </tr>
        <tr>
          <td style="border: 1px solid #e1e4e8; padding: 5px 14px;">TQQQ</td>
          <td style="border: 1px solid #e1e4e8; padding: 5px 14px;">9</td>
          <td style="border: 1px solid #e1e4e8; padding: 5px 14px;">82</td>
          <td style="border: 1px solid #e1e4e8; padding: 5px 14px;">13.59%</td>
          <td style="border: 1px solid #e1e4e8; padding: 5px 14px;">9.63%</td>
        </tr>
      </table>
      <div style="color: #129400; font-size: 1em; margin-top: 8px;">
        ✓ Use these exact headers (<b>column order doesn't matter</b>)
      </div>
      <button onclick="document.getElementById('csvModal').style.display='none';"
        style="margin-top:18px; padding:4px 18px; border-radius:5px; background:#1a7af6; color:white; border:none; font-size:0.96em; cursor:pointer;">
        Close
      </button>
    </div>
  </div>

  <script>
    // Modal open/close
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('csvTemplateLink').onclick = function(e){
        e.preventDefault();
        document.getElementById('csvModal').style.display = 'block';
      };
    });

    let allData = {};
    let rawText = null;
    const csvInput = document.getElementById('csvInput'),
          symbolSelect = document.getElementById('symbolSelect'),
          arFloor = document.getElementById('arFloor'),
          arFloorNum = document.getElementById('arFloorNum'),
          mdMin = document.getElementById('mdMin'),
          mdMinNum = document.getElementById('mdMinNum'),
          mdCeil = document.getElementById('mdCeil'),
          mdCeilNum = document.getElementById('mdCeilNum'),
          zMin = document.getElementById('zMin'),
          zMax = document.getElementById('zMax'),
          hoverX = document.getElementById('hoverX'),
          hoverY = document.getElementById('hoverY'),
          currentMaxH = document.getElementById('currentMaxH'),
          heatDiv = document.getElementById('heatmap'),
          dataSourceSelect = document.getElementById('dataSourceSelect'),
          otherSourceBox = document.getElementById('otherSourceBox'),
          clearDataBtn = document.getElementById('clearDataBtn'),
          decimalToPercentBox = document.getElementById('decimalToPercentBox'),
          exportCSVBtn = document.getElementById('exportCSVBtn');

    // Show/hide "Other" input
    dataSourceSelect.addEventListener('change', () => {
      otherSourceBox.style.display = dataSourceSelect.value === "Other" ? "" : "none";
    });

    // CLEAR DATA BUTTON
    clearDataBtn.addEventListener('click', () => {
      allData = {};
      symbolSelect.innerHTML = '';
      Plotly.purge(heatDiv);
      hoverX.innerText = '';
      hoverY.innerText = '';
      currentMaxH.textContent = 'Current Max H: --';
    });

    // AUTOLOAD CSV ON PAGE LOAD (default source = "Exxahub")
    window.addEventListener('DOMContentLoaded', () => {
      fetch('data/LoadDataTQQQ.csv')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.text();
        })
        .then(csvText => {
          rawText = csvText;
          buildFromText(csvText, "Exxahub");
          populateSymbols();
        })
        .catch(error => {
          console.log('Autoload CSV error:', error);
        });
    });

    function populateSymbols() {
      symbolSelect.innerHTML = '';
      Object.keys(allData).forEach(s => {
        const opt = document.createElement('option');
        opt.value = opt.text = s;
        symbolSelect.appendChild(opt);
      });
      if (symbolSelect.options.length) {
        symbolSelect.selectedIndex = 0;
        drawHeatmap();
      }
    }

    csvInput.addEventListener('change', e => {
      const reader = new FileReader();
      reader.onload = evt => {
        rawText = evt.target.result;
        let source = dataSourceSelect.value;
        if (source === "Other") {
          source = otherSourceBox.value.trim() || "Other";
        }
        buildFromText(rawText, source);
        populateSymbols();
      };
      reader.readAsText(e.target.files[0]);
    });

    [arFloor, arFloorNum].forEach(el => el.oninput = () => {
      arFloor.value = arFloorNum.value = el.value;
      drawHeatmap();
    });
    [mdMin, mdMinNum].forEach(el => el.oninput = () => {
      mdMin.value = mdMinNum.value = el.value;
      drawHeatmap();
    });
    [mdCeil, mdCeilNum].forEach(el => el.oninput = () => {
      mdCeil.value = mdCeilNum.value = el.value;
      drawHeatmap();
    });
    [zMin, zMax].forEach(el => el.oninput = drawHeatmap);
    symbolSelect.onchange = drawHeatmap;

    // Accepts new param: source
    function buildFromText(text, source) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return;

      const headerMap = {
        symbol: ['symbol', 'ticker', 'name'],
        day: ['day', 'days', 'timeframe', 'window', 'period', 'lookback'],
        rsi: ['rsi', 'relative strength index'],
        ar: ['ar', 'annualized return', 'cagr'],
        md: ['md', 'max drawdown', 'drawdown']
      };

      function findCol(headers, aliases) {
        for (let i = 0; i < headers.length; ++i) {
          const h = headers[i].trim().toLowerCase();
          if (aliases.includes(h)) return i;
        }
        return -1;
      }

      const headers = lines[0].split(',');
      const colIdx = {};
      Object.keys(headerMap).forEach(key => {
        const idx = findCol(
          headers,
          headerMap[key].map(s => s.toLowerCase())
        );
        if (idx === -1) {
          throw new Error(`Missing column for ${key} (${headerMap[key].join('/')})`);
        }
        colIdx[key] = idx;
      });

      // Store per-symbol per-source
      const temp = {};

      for (let i = 1; i < lines.length; ++i) {
        const c = lines[i].split(',');
        if (c.length < headers.length) continue;
        const symSource = c[colIdx.symbol] + " (" + source + ")";
        const d = +c[colIdx.day];
        const x = c[colIdx.rsi];
        let ar = parseFloat(c[colIdx.ar]), md = parseFloat(c[colIdx.md]);
        // Convert decimals to percent if checked
        if (decimalToPercentBox && decimalToPercentBox.checked) {
          ar *= 100;
          md *= 100;
        }
        const cm = (md === 0 ? null : ar / md);
        temp[symSource] = temp[symSource] || [];
        temp[symSource].push({ day: d, rsi: x, ar, md, cm });
      }

      // Merge into allData
      Object.keys(temp).forEach(s => {
        const arr = temp[s];
        const xs = Array.from(new Set(arr.map(o => o.rsi))).sort();
        const ys = Array.from(new Set(arr.map(o => o.day))).sort((a, b) => a - b);
        const arM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.ar : null;
        }));
        const mdM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.md : null;
        }));
        const cmM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.cm : null;
        }));
        allData[s] = { x: xs, y: ys, ar: arM, md: mdM, cm: cmM };
      });
    }

    // All slider logic now uses raw percent units
    function computeH(ar, md, floor, minMD) {
      return ar.map((row, i) => row.map((v, j) => {
        if (v == null) return null;
        return (v - floor) / Math.max(md[i][j], minMD);
      }));
    }

    // FULL DRAWHEATMAP FUNCTION
    function drawHeatmap() {
      const s = symbolSelect.value;
      if (!s) return;
      const D = allData[s];
      const floor = +arFloor.value;
      const minMD = +mdMin.value;
      const ceilMD = +mdCeil.value;
      const zminVal = +zMin.value;
      const zmaxVal = +zMax.value;
      const H = computeH(D.ar, D.md, floor, minMD);

      // MD ceiling mask: at 0 mask everything, at 100 mask nothing, in between mask values above slider.
      const EPSILON = 1e-6;
      let mask;
      if (ceilMD <= EPSILON) {
        mask = D.md.map(row => row.map(() => 1));
      } else if (ceilMD >= 100 - EPSILON) {
        mask = D.md.map(row => row.map(() => 0));
      } else {
        mask = D.md.map(row => row.map(v => (v != null && v > ceilMD) ? 1 : 0));
      }

      // Compute current max H
      let maxH = -Infinity;
      H.forEach(row => row.forEach(v => { if (v != null && v > maxH) maxH = v; }));
      currentMaxH.textContent = 'Current Max H: ' + maxH.toFixed(3);

      Plotly.newPlot(heatDiv, [
        {
          z: H,
          x: D.x,
          y: D.y,
          type: 'heatmap',
          colorscale: [[0, 'green'], [0.5, 'yellow'], [1, 'red']],
          zmin: zminVal,
          zmax: zmaxVal,
          customdata: D.ar.map((r, i) => r.map((_, j) => [D.ar[i][j], D.md[i][j], D.cm[i][j], H[i][j]])),
          hovertemplate: 'AR: %{customdata[0]:.2f}%<br>MD: %{customdata[1]:.2f}%<br>Calmar: %{customdata[2]:.2f}<br>H: %{customdata[3]:.3f}<extra></extra>'
        },
        {
          z: mask,
          x: D.x,
          y: D.y,
          type: 'heatmap',
          showscale: false,
          colorscale: [[0, 'rgba(0,0,0,0)'], [1, 'rgba(0,0,0,0.5)']],
          hoverinfo: 'skip'
        }
      ], {
        margin: { l: 60, r: 60, t: 60, b: 60 },
        xaxis: { title: 'RSI Threshold' },
        yaxis: { title: 'Lookback (days)' }
      }, { responsive: true });

      // Edge labels on hover
      heatDiv.on('plotly_hover', function(eventData) {
        var pt = eventData.points[0];
        document.getElementById('hoverX').innerText = 'RSI: ' + pt.x;
        document.getElementById('hoverY').innerText = 'Day: ' + pt.y;
      });
      heatDiv.on('plotly_unhover', function() {
        document.getElementById('hoverX').innerText = '';
        document.getElementById('hoverY').innerText = '';
      });
    }

    // ---- CSV Export Functionality ----
    exportCSVBtn.addEventListener('click', function(e) {
      // Only export on actual button, not CSV link
      if (e.target.classList.contains('csv-link')) return;
      const floor = +arFloor.value;
      const minMD = +mdMin.value;
      const ceilMD = +mdCeil.value;
      const hColName = `H (Rmin${floor}|Dmin${minMD}|Dmax${ceilMD})`;

      // CSV Header
      let csv = `Symbol,Days,RSI,AR,MD,Calmar,${hColName}\n`;
      Object.keys(allData).forEach(symbol => {
        const D = allData[symbol];
        const H = computeH(D.ar, D.md, floor, minMD);
        for (let i = 0; i < D.y.length; ++i) {
          for (let j = 0; j < D.x.length; ++j) {
            if (D.ar[i][j] == null) continue;
            csv += [
              `"${symbol}"`,
              D.y[i],
              D.x[j],
              D.ar[i][j],
              D.md[i][j],
              (D.cm[i][j] == null ? "" : D.cm[i][j]),
              (H[i][j] == null ? "" : H[i][j].toFixed(5))
            ].join(",") + "\n";
          }
        }
      });
      // Download
      const blob = new Blob([csv], {type: "text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "merged_heatmap_data.csv";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }, 0);
    });
  </script>
</body>
</html>
