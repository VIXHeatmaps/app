<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Heatmap Viewer 0.0.22</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h2 { margin-bottom: 5px; }
    .formula { font-style: italic; margin-bottom: 20px; }
    .header { display: flex; justify-content: space-between; align-items: flex-start; }
    .controls, .upload-box { flex: 1; }
    .upload-box { max-width: 350px; border: 1px solid #ccc; padding: 12px; border-radius: 6px; }
    .control { margin-bottom: 12px; }
    label { font-weight: bold; margin-right: 6px; }
    select, input[type="number"], input[type="text"] { vertical-align: middle; }
    input[type="range"] { width: 200px; vertical-align: middle; }
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 6px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top:0; left:0; right:0; bottom:0; background:#ccc; transition:.4s; border-radius:20px; }
    .slider:before { position:absolute; content:""; height:16px; width:16px; left:2px; bottom:2px; background:white; transition:.4s; border-radius:50%; }
    input:checked + .slider { background: #4CAF50; }
    input:checked + .slider:before { transform: translateX(20px); }
    #edgeContainer { display: flex; align-items: stretch; margin-top: 20px; }
    #hoverY { width: 80px; text-align: right; padding-right: 10px; }
    #heatmap { flex:1; }
    #hoverX-container { display: flex; justify-content: center; margin-top: 8px; }
    #hoverX { font-style: italic; }
  </style>
</head>
<body>

  <h2>Heatmap Viewer</h2>
  <div class="formula">
    <strong>Metric:</strong> H = (AR – AR<sub>min</sub>) / max(MD, MD<sub>min</sub>) (decimal)
  </div>

  <div class="header">
    <!-- LEFT PANEL: metric controls + symbol + source -->
    <div class="controls">
      <div class="control">
        <label for="symbolSelect">Symbol:</label>
        <select id="symbolSelect"></select>
        <span>(Source: <strong id="sourceName">Exxahub</strong>)</span>
      </div>
      <div class="control">
        <label for="arFloor">AR Min. (%):</label>
        <input type="range" id="arFloor" min="0" max="100" step="0.1" value="1">
        <input type="number" id="arFloorNum" min="0" max="100" step="0.1" value="1">
      </div>
      <div class="control">
        <label for="mdMin">MD Min. (%):</label>
        <input type="range" id="mdMin" min="0" max="100" step="0.1" value="3">
        <input type="number" id="mdMinNum" min="0" max="100" step="0.1" value="3">
      </div>
      <div class="control">
        <label for="mdCeil">MD Ceiling (%):</label>
        <input type="range" id="mdCeil" min="0" max="100" step="0.1" value="25">
        <input type="number" id="mdCeilNum" min="0" max="100" step="0.1" value="25">
      </div>
      <div class="control">
        <label for="zMin">Colorbar Min H:</label>
        <input type="number" id="zMin" step="0.01" value="-1">
        <label for="zMax">Max H:</label>
        <input type="number" id="zMax" step="0.01" value="1">
        <div id="currentMaxH">Current Max H: ––</div>
      </div>
    </div>

    <!-- RIGHT PANEL: upload, data-source, conversion, export -->
    <div class="upload-box">
      <div class="control">
        <label for="csvInput">Upload CSV:</label>
        <input type="file" id="csvInput" accept=".csv">
      </div>
      <div class="control">
        <label for="dataSource">Data Source:</label>
        <select id="dataSource">
          <option>Exxahub</option>
          <option>QuantMage</option>
          <option>Composer</option>
          <option>Testfol.io</option>
          <option>Other</option>
          <option selected>Unknown</option>
        </select>
        <input type="text" id="customSource" placeholder="Custom source" style="display:none; width:100%; margin-top:6px;">
      </div>
      <div class="control">
        <label class="format-label">Convert Data:</label>
        <span>×0.01</span>
        <label class="switch"><input type="checkbox" id="percentToggle" checked><span class="slider"></span></label>
        <span>×100</span>
      </div>
      <div class="control">
        <button id="exportBtn">Export Data CSV</button>
      </div>
    </div>
  </div>

  <!-- HEATMAP + EDGE HOVER LABELS -->
  <div id="edgeContainer">
    <div id="hoverY"></div>
    <div id="heatmap"></div>
  </div>
  <div id="hoverX-container"><div id="hoverX"></div></div>


  <script>
  // ————————————————————————————————————————————————
  // Globals & DOM refs
  let allData = {};               // { symbol: { x:[…], y:[…], ar:[][], md:[][], cm:[][] } }
  let symbolOrder = [];           // controls dropdown order
  let rawTexts = [];              // all CSV texts (initial + uploads)
  const csvInput      = document.getElementById('csvInput');
  const dataSourceSel = document.getElementById('dataSource');
  const customSource  = document.getElementById('customSource');
  const sourceName    = document.getElementById('sourceName');
  const pctToggle     = document.getElementById('percentToggle');
  const symbolSelect  = document.getElementById('symbolSelect');
  const arFloor       = document.getElementById('arFloor');
  const arFloorNum    = document.getElementById('arFloorNum');
  const mdMin         = document.getElementById('mdMin');
  const mdMinNum      = document.getElementById('mdMinNum');
  const mdCeil        = document.getElementById('mdCeil');
  const mdCeilNum     = document.getElementById('mdCeilNum');
  const zMin          = document.getElementById('zMin');
  const zMax          = document.getElementById('zMax');
  const currentMaxH   = document.getElementById('currentMaxH');
  const hoverX        = document.getElementById('hoverX');
  const hoverY        = document.getElementById('hoverY');
  const heatDiv       = document.getElementById('heatmap');
  const exportBtn     = document.getElementById('exportBtn');

  // — INITIAL LOAD: fetch preloaded CSV :contentReference[oaicite:1]{index=1}
  document.addEventListener('DOMContentLoaded', ()=>{
    fetch('data/FeaverSignalsFormatted.csv')
      .then(r=>r.text())
      .then(txt=>{
        rawTexts.push(txt);
        mergeCSV(txt);
        populateSymbols();
      })
      .catch(err=>console.error('Could not load startup CSV', err));

    // wire up UI events
    dataSourceSel.onchange = () => {
      customSource.style.display = dataSourceSel.value==='Other' ? 'block' : 'none';
      updateSourceLabel();
    };
    customSource.oninput = updateSourceLabel;

    csvInput.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ev => {
        rawTexts.push(ev.target.result);
        mergeCSV(ev.target.result);
        updateSourceLabel();
        populateSymbols();
        drawHeatmap();
      };
      r.readAsText(f);
    });

    pctToggle.addEventListener('change', ()=>{
      // re-parse *all* texts
      allData = {};
      symbolOrder = [];
      rawTexts.forEach(t=>mergeCSV(t));
      populateSymbols();
      drawHeatmap();
    });

    // sync sliders ↔ number inputs & redraw
    [[arFloor,arFloorNum], [mdMin,mdMinNum], [mdCeil,mdCeilNum]]
      .forEach(pair => pair.forEach(el=> el.oninput = ()=>{
        pair[0].value = pair[1].value = el.value;
        drawHeatmap();
      }));
    [zMin,zMax].forEach(el=> el.oninput = drawHeatmap);
    symbolSelect.onchange = drawHeatmap;
    exportBtn.onclick    = exportAllData;
  });

  // — UPDATE THE “Source:” LABEL NEXT TO SYMBOL
  function updateSourceLabel(){
    let ds = dataSourceSel.value;
    if(ds==='Other') ds = customSource.value.trim()||'Other';
    sourceName.textContent = ds;
  }

  // — MERGE A SINGLE CSV TEXT INTO allData (with header-synonym mapping)
  function mergeCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(lines.length<2) return;
    // identify columns by synonym
    const hdrs = lines[0].split(',').map(h=>h.trim().toLowerCase());
    const idx = nameList => hdrs.findIndex(h=> nameList.includes(h) );
    const iSym = idx(['symbol','ticker','name']);
    const iDay = idx(['day','days','window','lookback','timeframe','period']);
    const iRsi = idx(['rsi','relative strength index']);
    const iAr  = idx(['ar','cagr','annualized return','annual return']);
    const iMd  = idx(['md','max drawdown','drawdown']);
    const iCm  = idx(['calmar','calmar ratio']);
    const recs = {};
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',');
      if(cols.length<=Math.max(iSym,iDay,iRsi,iAr,iMd)) continue;
      const s = cols[iSym], d = +cols[iDay], x = cols[iRsi];
      let ar = parseFloat(cols[iAr]), md = parseFloat(cols[iMd]);
      const cm = iCm>=0 ? parseFloat(cols[iCm]) : null;
      if(pctToggle.checked){ ar/=100; md/=100; }
