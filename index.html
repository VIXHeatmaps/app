<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Heatmap Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
 <style>
    body {
      font-family: sans-serif;
      font-size: 12px;
      margin: 16px;
    }
    .header { display: flex; justify-content: space-between; align-items: flex-start; }
    .controls { flex: 1; }
    .right-controls {
      min-width: 270px;
      margin-top: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 7px;
      font-size: 12px;
    }
    .rc-row {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 12px;
    }
    .rc-row label,
    .csv-link,
    .export-btn,
    .select-note {
      font-size: 12px;
      font-family: inherit;
    }
    .csv-link {
      color: #0074d9;
      text-decoration: underline;
      cursor: pointer;
      font-weight: 600;
      margin: 0 2px;
    }
    .export-btn {
      background: #1884f7;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 3px 12px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 0;
      font-weight: 500;
      transition: background 0.13s;
    }
    .export-btn:hover { background: #0059b2; }
    .select-note { color: #189c2f; margin-left: 5px; }
    #csvModal {
      display: none;
      position: fixed;
      z-index: 12;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.17);
      align-items: center;
      justify-content: center;
    }
    #csvModal .modal-content {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      padding: 16px 18px 10px 18px;
      min-width: 220px;
      max-width: 95vw;
      min-height: 40px;
      font-size: 12px;
    }
    #csvModal table {
      border-collapse: collapse;
      width: 100%;
      margin: 6px 0;
      background: #fcfcfc;
      font-size: 12px;
    }
    #csvModal th, #csvModal td {
      border: 1px solid #d6d6d6;
      padding: 3px 6px;
      text-align: center;
      font-size: 12px;
    }
    #csvModal th {
      background: #f7f7f9;
      font-weight: bold;
    }
    #closeModalBtn {
      float: right;
      margin-top: -13px;
      margin-right: -8px;
      border: none;
      background: none;
      font-size: 17px;
      color: #888;
      cursor: pointer;
      font-family: inherit;
    }
    #closeModalBtn:hover { color: #333; }
    .heatmap-section {
      margin-top: 18px;
      padding-bottom: 18px;
      border-bottom: 1px solid #eee;
      font-size: 12px;
    }
    .heatmap-section:last-child { border-bottom: none; }
    .heatmap-title {
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 1px;
      color: #1b365d;
      letter-spacing: 0.01em;
    }
    .currentMaxH-label {
      font-weight: bold;
      margin-left:10px;
      font-size: 12px;
    }
    /* Multi-Select Styles */
    .symbol-multiselect {
      position: relative;
      width: 180px;
      max-width: 100%;
      margin-bottom: 5px;
      z-index: 11;
      display: inline-block;
      font-size: 12px;
    }
    .symbol-multiselect .selected-label {
      border: 1px solid #bbb;
      border-radius: 5px;
      padding: 2px 6px;
      min-height: 18px;
      cursor: pointer;
      font-size: 12px;
      background: #fafbfc;
      box-shadow: 0 1px 1px rgba(0,0,0,0.02);
      transition: border-color 0.12s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .symbol-multiselect .selected-label:after {
      content: "▼";
      float: right;
      font-size: 10px;
      color: #888;
      margin-left: 4px;
    }
    .symbol-multiselect.open .selected-label {
      border-color: #1884f7;
      background: #f5faff;
    }
    .symbol-multiselect-list {
      position: absolute;
      top: 107%;
      left: 0;
      right: 0;
      max-height: 120px;
      min-width: 120px;
      background: #fff;
      border: 1px solid #1884f7;
      border-radius: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 4px 0 4px 0;
      overflow-y: auto;
      z-index: 99;
      font-size: 12px;
    }
    .symbol-multiselect-list label {
      display: flex;
      align-items: center;
      padding: 2px 6px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.07s;
      font-size: 12px;
    }
    .symbol-multiselect-list label:hover { background: #f2f6ff; }
    .symbol-multiselect-list input[type=checkbox] { margin-right: 5px; }
    /* Compact controls */
    input[type="range"], input[type="number"], select, button, input[type="file"], label, input[type="checkbox"] {
      font-size: 12px;
      font-family: inherit;
      padding: 2px 2px;
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div class="controls">
      <div style="font-size: 19px; font-style: italic; margin-bottom: 14px; font-family: inherit;">
        <b>Metric:</b> H = (AR – AR<sub>min</sub>) / max(MD, MD<sub>min</sub>) <span style="font-size: 16px;">(decimal)</span>
      </div>
      <div style="font-weight:bold; margin-bottom:6px; font-size: 16px; font-family: inherit;">
        Symbol:
        <!-- Custom Collapsing Multi-Select -->
        <div class="symbol-multiselect" id="symbolMultiSelectBox">
          <div class="selected-label" tabindex="0" id="symbolMultiSelectLabel">Select Symbol</div>
          <div class="symbol-multiselect-list" id="symbolMultiSelectList" style="display:none;"></div>
        </div>
        <button id="clearDataBtn" style="margin-left:10px; font-size:16px; font-family: inherit;">Clear Data</button>
      </div>
      <div style="font-size:16px; font-family: inherit;"><b>AR Min. (%):</b>
        <input type="range" id="arFloor" min="0" max="100" step="0.1" value="3" style="width:180px;vertical-align:middle;">
        <input type="number" id="arFloorNum" min="0" max="100" step="0.1" value="3" style="width:50px;">
      </div>
      <div style="font-size:16px; font-family: inherit;"><b>MD Min. (%):</b>
        <input type="range" id="mdMin" min="0" max="100" step="0.1" value="5" style="width:180px;vertical-align:middle;">
        <input type="number" id="mdMinNum" min="0" max="100" step="0.1" value="5" style="width:50px;">
      </div>
      <div style="font-size:16px; font-family: inherit;"><b>MD Max (%):</b>
        <input type="range" id="mdCeil" min="0" max="100" step="0.1" value="50" style="width:180px;vertical-align:middle;">
        <input type="number" id="mdCeilNum" min="0" max="100" step="0.1" value="50" style="width:50px;">
      </div>
      <div style="margin-top: 6px; font-size:16px; font-family: inherit;">
        <b>Colorbar Min H:</b> <input type="number" id="zMin" step="0.01" value="-1" style="width:48px;">
        <b style="margin-left:6px;">Colorbar Max H:</b> <input type="number" id="zMax" step="0.01" value="1" style="width:48px;">
        <span id="currentMaxH" class="currentMaxH-label">Current Max H: --</span>
      </div>
    </div>
    <div class="right-controls">
      <div class="rc-row">
        <label for="dataSourceSelect">Data Source:</label>
        <select id="dataSourceSelect">
          <option>Exxahub</option>
          <option>Testfol.io</option>
          <option>Composer</option>
          <option>Quantmage</option>
          <option>Other</option>
        </select>
      </div>
      <div class="rc-row">
        <label style="font-weight: bold;">Upload <span class="csv-link" id="showCsvTemplate">CSV</span>:</label>
        <input type="file" id="csvInput" accept=".csv">
      </div>
      <div class="rc-row">
        <input type="checkbox" id="decimalToPercentBox">
        <label for="decimalToPercentBox" style="font-weight:normal; margin-left:2px;">Decimal → %</label>
        <span class="select-note">(select prior to upload)</span>
      </div>
      <button id="exportCSVBtn" class="export-btn">Download Data</button>
    </div>
  </div>

  <!-- CSV Modal -->
  <div id="csvModal">
    <div class="modal-content">
      <button id="closeModalBtn" title="Close">&times;</button>
      <div style="font-weight: bold; margin-bottom: 8px;">CSV Upload Template</div>
      <table>
        <tr>
          <th>Symbol</th>
          <th>Days</th>
          <th>RSI</th>
          <th>AR</th>
          <th>MD</th>
        </tr>
        <tr>
          <td>TQQQ</td>
          <td>9</td>
          <td>82</td>
          <td>13.59%</td>
          <td>9.63%</td>
        </tr>
      </table>
      <div style="color: #008000; font-size: 16px; margin-top: 6px; font-family: inherit;">
        ✓ Use these exact headers (<b>column order doesn't matter</b>)
      </div>
      <div style="margin-top:10px; color:#444; font-size: 16px; font-family: inherit;">
        You may also use: <b>Ticker</b>, <b>Name</b> for Symbol; <b>Lookback</b>, <b>Window</b> for Days; <b>Drawdown</b> for MD, <b>CAGR</b> for AR, etc.
      </div>
    </div>
  </div>

  <!-- Stacked heatmaps -->
  <div id="heatmapsContainer"></div>

  <script>
    // CSV MODAL LOGIC
    document.getElementById('showCsvTemplate').onclick = function() {
      document.getElementById('csvModal').style.display = 'flex';
    };
    document.getElementById('closeModalBtn').onclick = function() {
      document.getElementById('csvModal').style.display = 'none';
    };
    window.onclick = function(event) {
      if (event.target === document.getElementById('csvModal')) {
        document.getElementById('csvModal').style.display = 'none';
      }
    };

    let allData = {};
    let rawText = null;
    let selectedSymbols = [];
    let allSymbolList = [];

    const csvInput = document.getElementById('csvInput'),
          arFloor = document.getElementById('arFloor'),
          arFloorNum = document.getElementById('arFloorNum'),
          mdMin = document.getElementById('mdMin'),
          mdMinNum = document.getElementById('mdMinNum'),
          mdCeil = document.getElementById('mdCeil'),
          mdCeilNum = document.getElementById('mdCeilNum'),
          zMin = document.getElementById('zMin'),
          zMax = document.getElementById('zMax'),
          currentMaxH = document.getElementById('currentMaxH'),
          dataSourceSelect = document.getElementById('dataSourceSelect'),
          clearDataBtn = document.getElementById('clearDataBtn'),
          decimalToPercentBox = document.getElementById('decimalToPercentBox'),
          exportCSVBtn = document.getElementById('exportCSVBtn'),
          heatmapsContainer = document.getElementById('heatmapsContainer');

    // Custom multi-select elements
    const symbolMultiSelectBox = document.getElementById('symbolMultiSelectBox');
    const symbolMultiSelectLabel = document.getElementById('symbolMultiSelectLabel');
    const symbolMultiSelectList = document.getElementById('symbolMultiSelectList');

    // Populate symbols for multi-select
    function populateSymbols() {
      allSymbolList = Object.keys(allData);
      selectedSymbols = [];
      symbolMultiSelectList.innerHTML = '';
      allSymbolList.forEach((sym, idx) => {
        const id = `multisym-${idx}`;
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" id="${id}" value="${sym}"> ${sym}`;
        symbolMultiSelectList.appendChild(label);
      });
      // Auto-select first symbol and update UI
      if (allSymbolList.length) {
        selectedSymbols = [allSymbolList[0]];
        symbolMultiSelectList.querySelector('input').checked = true;
        updateSymbolLabel();
        drawHeatmaps();
      } else {
        updateSymbolLabel();
        drawHeatmaps();
      }
    }

    // Open/collapse handlers
    function openSymbolList() {
      symbolMultiSelectList.style.display = 'block';
      symbolMultiSelectBox.classList.add('open');
      symbolMultiSelectLabel.focus();
    }
    function closeSymbolList() {
      symbolMultiSelectList.style.display = 'none';
      symbolMultiSelectBox.classList.remove('open');
    }
    symbolMultiSelectLabel.onclick = (e) => {
      if (symbolMultiSelectList.style.display === 'block') {
        closeSymbolList();
      } else {
        openSymbolList();
      }
    };
    symbolMultiSelectLabel.onkeydown = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openSymbolList();
      }
    };
    symbolMultiSelectList.onclick = (e) => {
      if (e.target.tagName === "INPUT") {
        const sym = e.target.value;
        if (e.target.checked) {
          if (!selectedSymbols.includes(sym)) selectedSymbols.push(sym);
        } else {
          selectedSymbols = selectedSymbols.filter(s => s !== sym);
        }
        updateSymbolLabel();
        drawHeatmaps();
      }
    };
    document.addEventListener('mousedown', (e) => {
      if (!symbolMultiSelectBox.contains(e.target)) {
        closeSymbolList();
      }
    });

    function updateSymbolLabel() {
      if (selectedSymbols.length === 0) {
        symbolMultiSelectLabel.innerText = "Select Symbol";
      } else if (selectedSymbols.length === 1) {
        symbolMultiSelectLabel.innerText = selectedSymbols[0];
      } else {
        symbolMultiSelectLabel.innerText = `${selectedSymbols.length} symbols`;
      }
    }

    // CLEAR DATA BUTTON
    clearDataBtn.addEventListener('click', () => {
      allData = {};
      selectedSymbols = [];
      allSymbolList = [];
      symbolMultiSelectList.innerHTML = '';
      updateSymbolLabel();
      heatmapsContainer.innerHTML = '';
      currentMaxH.textContent = 'Current Max H: --';
    });

    // AUTOLOAD CSV ON PAGE LOAD (default source = "Exxahub")
    window.addEventListener('DOMContentLoaded', () => {
      fetch('data/LoadDataTQQQ.csv')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.text();
        })
        .then(csvText => {
          rawText = csvText;
          buildFromText(csvText, "Exxahub");
          populateSymbols();
        })
        .catch(error => {
          console.log('Autoload CSV error:', error);
        });
    });

    csvInput.addEventListener('change', e => {
      const reader = new FileReader();
      reader.onload = evt => {
        rawText = evt.target.result;
        let source = dataSourceSelect.value;
        buildFromText(rawText, source);
        populateSymbols();
      };
      reader.readAsText(e.target.files[0]);
    });

    // Controls sync
    [arFloor, arFloorNum].forEach(el => el.oninput = () => {
      arFloor.value = arFloorNum.value = el.value;
      drawHeatmaps();
    });
    [mdMin, mdMinNum].forEach(el => el.oninput = () => {
      mdMin.value = mdMinNum.value = el.value;
      drawHeatmaps();
    });
    [mdCeil, mdCeilNum].forEach(el => el.oninput = () => {
      mdCeil.value = mdCeilNum.value = el.value;
      drawHeatmaps();
    });
    [zMin, zMax].forEach(el => el.oninput = drawHeatmaps);

    function buildFromText(text, source) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return;

      const headerMap = {
        symbol: ['symbol', 'ticker', 'name'],
        day: ['day', 'days', 'timeframe', 'window', 'period', 'lookback'],
        rsi: ['rsi', 'relative strength index'],
        ar: ['ar', 'annualized return', 'cagr'],
        md: ['md', 'max drawdown', 'drawdown']
      };

      function findCol(headers, aliases) {
        for (let i = 0; i < headers.length; ++i) {
          const h = headers[i].trim().toLowerCase();
          if (aliases.includes(h)) return i;
        }
        return -1;
      }

      const headers = lines[0].split(',');
      const colIdx = {};
      Object.keys(headerMap).forEach(key => {
        const idx = findCol(
          headers,
          headerMap[key].map(s => s.toLowerCase())
        );
        if (idx === -1) {
          throw new Error(`Missing column for ${key} (${headerMap[key].join('/')})`);
        }
        colIdx[key] = idx;
      });

      // Store per-symbol per-source
      const temp = {};

      for (let i = 1; i < lines.length; ++i) {
        const c = lines[i].split(',');
        if (c.length < headers.length) continue;
        const symSource = c[colIdx.symbol] + " (" + source + ")";
        const d = +c[colIdx.day];
        const x = c[colIdx.rsi];
        let ar = parseFloat(c[colIdx.ar]), md = parseFloat(c[colIdx.md]);
        // Convert decimals to percent if checked
        if (decimalToPercentBox && decimalToPercentBox.checked) {
          ar *= 100;
          md *= 100;
        }
        const cm = (md === 0 ? null : ar / md);
        temp[symSource] = temp[symSource] || [];
        temp[symSource].push({ day: d, rsi: x, ar, md, cm });
      }

      // Merge into allData
      Object.keys(temp).forEach(s => {
        const arr = temp[s];
        const xs = Array.from(new Set(arr.map(o => o.rsi))).sort();
        const ys = Array.from(new Set(arr.map(o => o.day))).sort((a, b) => a - b);
        const arM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.ar : null;
        }));
        const mdM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.md : null;
        }));
        const cmM = ys.map(y => xs.map(x => {
          const rec = arr.find(o => o.day === y && o.rsi === x);
          return rec ? rec.cm : null;
        }));
        allData[s] = { x: xs, y: ys, ar: arM, md: mdM, cm: cmM };
      });
    }

    function computeH(ar, md, floor, minMD) {
      return ar.map((row, i) => row.map((v, j) => {
        if (v == null) return null;
        return (v - floor) / Math.max(md[i][j], minMD);
      }));
    }

    function drawHeatmaps() {
      heatmapsContainer.innerHTML = '';
      if (!selectedSymbols.length) {
        currentMaxH.textContent = 'Current Max H: --';
        const msg = document.createElement('div');
        msg.style.textAlign = 'center';
        msg.style.margin = '60px 0 40px 0';
        msg.style.color = '#666';
        msg.style.fontSize = '1.15em';
        msg.innerHTML = 'Select one or more symbols above to view heatmaps.';
        heatmapsContainer.appendChild(msg);
        return;
      }
      let overallMaxH = -Infinity;
      selectedSymbols.forEach(symbol => {
        const D = allData[symbol];
        if (!D) return;
        const floor = +arFloor.value;
        const minMD = +mdMin.value;
        const ceilMD = +mdCeil.value;
        const zminVal = +zMin.value;
        const zmaxVal = +zMax.value;
        const H = computeH(D.ar, D.md, floor, minMD);

        // MD ceiling mask
        const EPSILON = 1e-6;
        let mask;
        if (ceilMD <= EPSILON) {
          mask = D.md.map(row => row.map(() => 1));
        } else if (ceilMD >= 100 - EPSILON) {
          mask = D.md.map(row => row.map(() => 0));
        } else {
          mask = D.md.map(row => row.map(v => (v != null && v > ceilMD) ? 1 : 0));
        }

        // Max H for this symbol
        let maxH = -Infinity;
        H.forEach(row => row.forEach(v => { if (v != null && v > maxH) maxH = v; }));
        if (maxH > overallMaxH) overallMaxH = maxH;

        // Create container for this heatmap
        const section = document.createElement('div');
        section.className = 'heatmap-section';
        section.innerHTML = `<div class="heatmap-title">${symbol}</div>
          <div id="heatmap-${symbol.replace(/[^a-zA-Z0-9]/g, '_')}" style="height: 60vh;"></div>
          <div style="display: flex; justify-content: space-between; font-size: 0.97em;">
            <span id="hoverX-${symbol.replace(/[^a-zA-Z0-9]/g, '_')}"></span>
            <span id="hoverY-${symbol.replace(/[^a-zA-Z0-9]/g, '_')}"></span>
          </div>`;
        heatmapsContainer.appendChild(section);

        // Draw heatmap in this container
        const heatDiv = section.querySelector('div[id^="heatmap-"]');
        Plotly.newPlot(heatDiv, [
          {
            z: H,
            x: D.x,
            y: D.y,
            type: 'heatmap',
            colorscale: [[0, 'green'], [0.5, 'yellow'], [1, 'red']],
            zmin: zminVal,
            zmax: zmaxVal,
            customdata: D.ar.map((r, i) => r.map((_, j) => [D.ar[i][j], D.md[i][j], D.cm[i][j], H[i][j]])),
            hovertemplate: 'AR: %{customdata[0]:.2f}%<br>MD: %{customdata[1]:.2f}%<br>Calmar: %{customdata[2]:.2f}<br>H: %{customdata[3]:.3f}<extra></extra>'
          },
          {
            z: mask,
            x: D.x,
            y: D.y,
            type: 'heatmap',
            showscale: false,
            colorscale: [[0, 'rgba(0,0,0,0)'], [1, 'rgba(0,0,0,0.5)']],
            hoverinfo: 'skip'
          }
        ], {
          margin: { l: 60, r: 60, t: 60, b: 60 },
          xaxis: { title: 'RSI Threshold' },
          yaxis: { title: 'Lookback (days)' }
        }, { responsive: true });

        // Add crosshairs to each heatmap (per symbol)
        const hoverX = section.querySelector(`#hoverX-${symbol.replace(/[^a-zA-Z0-9]/g, '_')}`);
        const hoverY = section.querySelector(`#hoverY-${symbol.replace(/[^a-zA-Z0-9]/g, '_')}`);
        heatDiv.on('plotly_hover', function(eventData) {
          var pt = eventData.points[0];
          hoverX.innerText = 'RSI: ' + pt.x;
          hoverY.innerText = 'Day: ' + pt.y;
        });
        heatDiv.on('plotly_unhover', function() {
          hoverX.innerText = '';
          hoverY.innerText = '';
        });
      });

      // Show overall max H across all selected heatmaps
      if (overallMaxH === -Infinity) {
        currentMaxH.textContent = 'Current Max H: --';
      } else {
        currentMaxH.textContent = 'Current Max H: ' + overallMaxH.toFixed(3);
      }
    }

    // CSV Export for ALL selected
    exportCSVBtn.addEventListener('click', function() {
      const floor = +arFloor.value;
      const minMD = +mdMin.value;
      const ceilMD = +mdCeil.value;
      const hColName = `H (Rmin${floor}|Dmin${minMD}|Dmax${ceilMD})`;

      let csv = `Symbol,Days,RSI,AR,MD,Calmar,${hColName}\n`;
      selectedSymbols.forEach(symbol => {
        const D = allData[symbol];
        if (!D) return;
        const H = computeH(D.ar, D.md, floor, minMD);
        for (let i = 0; i < D.y.length; ++i) {
          for (let j = 0; j < D.x.length; ++j) {
            if (D.ar[i][j] == null) continue;
            csv += [
              `"${symbol}"`,
              D.y[i],
              D.x[j],
              D.ar[i][j],
              D.md[i][j],
              (D.cm[i][j] == null ? "" : D.cm[i][j]),
              (H[i][j] == null ? "" : H[i][j].toFixed(5))
            ].join(",") + "\n";
          }
        }
      });
      const blob = new Blob([csv], {type: "text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "merged_heatmap_data.csv";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }, 0);
    });

  </script>
</body>
</html>
